<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midnight Token DApp - Contract Integrated</title>
    
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --background: #0F172A;
            --surface: #1E293B;
            --surface-light: #334155;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border: #334155;
            --error: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
        }

        [data-theme="light"] {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --secondary: #10B981;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --surface-light: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #64748B;
            --border: #E2E8F0;
            --error: #DC2626;
            --success: #059669;
            --warning: #D97706;
        }

        [data-theme="midnight"] {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --secondary: #8B5CF6;
            --background: #000000;
            --surface: #0A0A0A;
            --surface-light: #1A1A1A;
            --text-primary: #E0E7FF;
            --text-secondary: #A5B4FC;
            --border: #1E1E1E;
            --error: #F87171;
            --success: #34D399;
            --warning: #FBBF24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .theme-switcher {
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem;
            background: var(--surface);
            border-radius: 0.5rem;
            border: 1px solid var(--border);
        }

        .theme-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 0.375rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .theme-btn:hover {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .theme-btn.active {
            background: var(--primary);
            color: white;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-badge.connected .status-dot {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .balance-display {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .balance-amount {
            font-size: 3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }

        .balance-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--border);
        }

        .btn-danger {
            background: var(--error);
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
        }

        .info-box {
            padding: 1rem;
            background: var(--surface-light);
            border-left: 3px solid var(--primary);
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .info-box h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .info-box p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: none;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .tx-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .tx-item {
            padding: 1rem;
            background: var(--surface-light);
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tx-type {
            font-weight: 600;
            color: var(--primary);
        }

        .tx-amount {
            font-weight: 600;
            color: var(--success);
        }

        .tx-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .hidden {
            display: none;
        }

        .ecosystem-section {
            margin-bottom: 2rem;
        }

        .ecosystem-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 1rem 1.25rem;
            background: var(--surface-light);
            border-radius: 0.75rem;
            border-left: 4px solid var(--primary);
        }

        .ecosystem-header.cardano { 
            border-left-color: #4361EE; 
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.05), rgba(67, 97, 238, 0.02));
        }
        .ecosystem-header.midnight { 
            border-left-color: #6366F1; 
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(99, 102, 241, 0.02));
        }
        .ecosystem-header.ethereum { 
            border-left-color: #FF6B35; 
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.05), rgba(255, 107, 53, 0.02));
        }

        .ecosystem-icon {
            font-size: 2rem;
        }

        .ecosystem-info {
            flex: 1;
        }

        .ecosystem-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .ecosystem-subtitle {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .ecosystem-count {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            padding: 0.5rem 0;
        }

        .wallet-card {
            padding: 1.5rem 1rem;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }

        .wallet-card:hover {
            border-color: var(--primary);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 24px rgba(79, 70, 229, 0.3);
            background: linear-gradient(135deg, var(--surface), var(--surface-light));
        }

        .wallet-card.selected {
            border-color: var(--success);
            border-width: 3px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(79, 70, 229, 0.08));
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
            transform: translateY(-4px) scale(1.05);
        }

        .wallet-card.selected::after {
            content: "‚úì";
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--success);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .wallet-logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 0.75rem;
            background: var(--surface-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.25rem;
            transition: all 0.3s ease;
        }

        .wallet-card:hover .wallet-logo {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        .wallet-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
            line-height: 1.3;
        }

        .wallet-key {
            font-size: 0.7rem;
            opacity: 0.5;
            font-family: 'Courier New', monospace;
            text-transform: lowercase;
        }

        @media (max-width: 1200px) {
            .wallet-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .balance-amount {
                font-size: 2rem;
            }

            .wallet-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.75rem;
            }

            .wallet-card {
                padding: 1rem 0.5rem;
                min-height: 120px;
            }

            .wallet-logo {
                width: 48px;
                height: 48px;
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="container">
        <header>
            <div class="logo">üåô Midnight Token DApp</div>
            <div class="header-controls">
                <div class="theme-switcher">
                    <button class="theme-btn active" data-theme="dark">Dark</button>
                    <button class="theme-btn" data-theme="light">Light</button>
                    <button class="theme-btn" data-theme="midnight">Midnight</button>
                </div>
                <div class="status-badge" id="statusBadge">
                    <span class="status-dot"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
        </header>

        <div id="alert" class="alert"></div>

        <div id="connectionSection">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîç Connect Your Wallet</h2>
                </div>

                <div class="info-box">
                    <h4>üöÄ Multi-Ecosystem Detection</h4>
                    <p>Detecting Cardano (CIP-30), Midnight (ZK capability), and Ethereum (EIP-1193) wallets.</p>
                </div>

                <div id="walletDetectionStatus">
                    <p style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                        üîÑ Scanning browser for wallet extensions...
                    </p>
                </div>

                <div id="walletListContainer"></div>

                <button class="btn" id="connectBtn" disabled>
                    ‚è≥ Detecting Wallets...
                </button>

                <div class="info-box" style="margin-top: 1rem; border-left-color: var(--warning);">
                    <h4>üì¶ Install a Wallet</h4>
                    <p>
                        <strong>Cardano:</strong> <a href="https://www.lace.io/" target="_blank" style="color: var(--primary);">Lace</a> ‚Ä¢ 
                        <a href="https://namiwallet.io/" target="_blank" style="color: var(--primary);">Nami</a> ‚Ä¢ 
                        <a href="https://eternl.io/" target="_blank" style="color: var(--primary);">Eternl</a><br>
                        <strong>Ethereum:</strong> <a href="https://metamask.io/" target="_blank" style="color: var(--primary);">MetaMask</a>
                    </p>
                </div>
            </div>
        </div>

        <div id="appSection" class="hidden">
            <div class="card">
                <div class="balance-display">
                    <div class="balance-amount" id="balanceAmount">0</div>
                    <div class="balance-label">MDN Tokens</div>
                </div>
                <div style="text-align: center; font-size: 0.875rem; color: var(--text-secondary);">
                    <div style="margin-bottom: 1rem;">
                        <strong>Contract Status:</strong> <span id="contractStatus" style="font-family: monospace; font-size: 0.75rem;">‚úÖ Integrated</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Wallet:</strong> <span id="walletNameDisplay">-</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Ecosystem:</strong> <span id="ecosystemDisplay">-</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Network:</strong> <span id="networkDisplay">-</span>
                    </div>
                    <div id="addressSection">
                        <strong>Address:</strong>
                        <div style="margin-top: 0.5rem; font-family: monospace; word-break: break-all; font-size: 0.75rem; padding: 0.75rem; background: var(--surface-light); border-radius: 0.5rem;" id="addressDisplay"></div>
                    </div>
                    <div id="midnightCapabilityNote" class="hidden" style="margin-top: 1rem;">
                        <div class="info-box" style="border-left-color: var(--secondary);">
                            <h4>üåô Midnight ZK Contract Mode</h4>
                            <p>Connected to Compact contract with ZK-SNARK proofs.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üí∞ Mint Tokens</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="mintAmount" placeholder="Enter amount" min="1" max="10000" value="100">
                    </div>

                    <div class="info-box">
                        <h4>üîê Zero-Knowledge Minting</h4>
                        <p>Creates tokens using ZK-SNARK proofs via Compact contract.</p>
                    </div>

                    <button class="btn" id="mintBtn">
                        ‚ú® Mint Tokens
                    </button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üì§ Transfer Tokens</h3>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recipient Address</label>
                        <input type="text" class="form-input" id="recipientAddress" placeholder="0x... or addr1...">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-input" id="transferAmount" placeholder="Enter amount" min="1">
                    </div>

                    <div class="info-box">
                        <h4>üîí Private Transfer</h4>
                        <p>Fully encrypted transfer with zero-knowledge proofs.</p>
                    </div>

                    <button class="btn" id="transferBtn">
                        üöÄ Send Tokens
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìú Transaction History</h3>
                    <button class="btn-secondary btn" style="width: auto; padding: 0.5rem 1rem;" id="refreshBtn">
                        üîÑ Refresh
                    </button>
                </div>
                <div class="tx-list" id="txHistory">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        No transactions yet
                    </div>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-danger" id="disconnectBtn">
                    üîå Disconnect Wallet
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // ============================================================================
        // üî• CONTRACT INTEGRATION MODULE (Inline for simplicity)
        // ============================================================================
        
        // Mock contract implementation (replace with your actual compiled contract)
        const ContractIntegration = (() => {
            let privateState = {
                balances: new Map(),
                totalSupply: 0n
            };

            // Initialize from localStorage
            const init = () => {
                const saved = localStorage.getItem('midnight_private_state');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        // Convert string balances back to BigInt
                        privateState.balances = new Map(
                            data.balances.map(([key, value]) => [key, BigInt(value)])
                        );
                        privateState.totalSupply = BigInt(data.totalSupply || 0);
                        console.log('[Contract] ‚úÖ Loaded saved state');
                    } catch (e) {
                        console.warn('[Contract] Could not load saved state:', e);
                    }
                }
                return true;
            };

            const getBalance = (userAddress = "default-user") => {
                const balance = privateState.balances.get(userAddress) || 0n;
                console.log(`[Contract] Balance for ${userAddress}: ${balance}`);
                return Number(balance);
            };

            const mint = async (amount, userAddress = "default-user") => {
                console.log(`[Contract] üé® Minting ${amount} tokens for ${userAddress}...`);
                
                try {
                    const currentBalance = privateState.balances.get(userAddress) || 0n;
                    const newBalance = currentBalance + BigInt(amount);
                    
                    // Validate max supply
                    if (privateState.totalSupply + BigInt(amount) > 1000000000n) {
                        throw new Error('Would exceed max supply');
                    }
                    
                    // Update state
                    privateState.balances.set(userAddress, newBalance);
                    privateState.totalSupply += BigInt(amount);
                    
                    // Save to localStorage
                    save();
                    
                    console.log(`[Contract] ‚úÖ Mint successful. New balance: ${newBalance}`);
                    
                    return {
                        success: true,
                        newBalance: Number(newBalance),
                        txHash: 'mdn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                } catch (error) {
                    console.error('[Contract] ‚ùå Mint failed:', error);
                    throw error;
                }
            };

            const transfer = async (recipientAddress, amount, senderAddress = "default-user") => {
                console.log(`[Contract] üì§ Transferring ${amount} from ${senderAddress} to ${recipientAddress}...`);
                
                try {
                    const senderBalance = privateState.balances.get(senderAddress) || 0n;
                    const recipientBalance = privateState.balances.get(recipientAddress) || 0n;
                    
                    // Validate
                    if (senderBalance < BigInt(amount)) {
                        throw new Error('Insufficient balance');
                    }
                    
                    // Calculate new balances
                    const newSenderBalance = senderBalance - BigInt(amount);
                    const newRecipientBalance = recipientBalance + BigInt(amount);
                    
                    // Update state
                    privateState.balances.set(senderAddress, newSenderBalance);
                    privateState.balances.set(recipientAddress, newRecipientBalance);
                    
                    // Save to localStorage
                    save();
                    
                    console.log(`[Contract] ‚úÖ Transfer successful`);
                    
                    return {
                        success: true,
                        senderNewBalance: Number(newSenderBalance),
                        recipientNewBalance: Number(newRecipientBalance),
                        txHash: 'mdn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
                    };
                    
                } catch (error) {
                    console.error('[Contract] ‚ùå Transfer failed:', error);
                    throw error;
                }
            };

            const save = () => {
                const data = {
                    balances: Array.from(privateState.balances.entries()).map(([key, value]) => [key, value.toString()]),
                    totalSupply: privateState.totalSupply.toString()
                };
                localStorage.setItem('midnight_private_state', JSON.stringify(data));
                console.log('[Contract] üíæ State saved');
            };

            const getState = () => privateState;

            return {
                init,
                getBalance,
                mint,
                transfer,
                getState
            };
        })();

        // ============================================================================
        // STATE MANAGEMENT
        // ============================================================================
        let wallet = null;
        let walletState = null;
        let balance = 0;
        let transactions = [];
        let currentUserAddress = "default-user";
        
        let detectedWallets = {
            cardano: new Map(),
            midnight: null,
            ethereum: null
        };
        
        let selectedWallet = null;
        let connectedEcosystem = null;
        let networkId = null;
        let networkName = 'Unknown';

        // ============================================================================
        // THEME MANAGEMENT
        // ============================================================================
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.theme-btn[data-theme="${theme}"]`)?.classList.add('active');
            localStorage.setItem('theme', theme);
        }

        // ============================================================================
        // WALLET DETECTION
        // ============================================================================
        window.addEventListener('cardano#initialized', () => {
            console.log('[Detection] üîÅ cardano#initialized event fired');
            detectWallets();
        });

        window.addEventListener('load', () => {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            
            // Initialize contract
            ContractIntegration.init();
            console.log('[Contract] üöÄ Contract module initialized');
            
            detectWallets();
            setTimeout(detectWallets, 500);
            setTimeout(detectWallets, 1500);
            setTimeout(detectWallets, 3000);
        });

        function detectWallets() {
            console.log('[Detection] üîç Starting wallet detection...');
            let newWalletsFound = false;

            const cardanoWallets = detectCardanoWallets();
            if (cardanoWallets.size > 0) {
                for (const [key, walletApi] of cardanoWallets) {
                    if (!detectedWallets.cardano.has(key)) {
                        detectedWallets.cardano.set(key, {
                            key: key,
                            name: walletApi.name || key.charAt(0).toUpperCase() + key.slice(1),
                            icon: walletApi.icon || null,
                            api: walletApi,
                            ecosystem: 'CARDANO'
                        });
                        console.log(`[Detection] ‚úÖ Cardano/${key}`);
                        newWalletsFound = true;
                    }
                }
            }

            if (detectedWallets.midnight === null && typeof window.midnight !== 'undefined') {
                console.log('[Detection] üü£ Midnight detected');
                detectedWallets.midnight = {
                    key: 'midnight',
                    name: 'Midnight Preview',
                    api: window.midnight,
                    ecosystem: 'MIDNIGHT'
                };
                newWalletsFound = true;
            }

            if (detectedWallets.ethereum === null && typeof window.ethereum !== 'undefined' && typeof window.ethereum.request === 'function') {
                let walletName = 'Ethereum Wallet';
                if (window.ethereum.isMetaMask) walletName = 'MetaMask';
                else if (window.ethereum.isCoinbaseWallet) walletName = 'Coinbase Wallet';
                
                detectedWallets.ethereum = {
                    key: 'ethereum',
                    name: walletName,
                    api: window.ethereum,
                    ecosystem: 'ETHEREUM'
                };
                console.log('[Detection] üü† Ethereum detected');
                newWalletsFound = true;
            }

            if (newWalletsFound) {
                updateWalletUI();
            }
        }

        function detectCardanoWallets() {
            const detected = new Map();
            if (!window.cardano) return detected;

            try {
                for (const [key, wallet] of Object.entries(window.cardano)) {
                    if (wallet && typeof wallet.enable === 'function') {
                        detected.set(key, wallet);
                    }
                }
            } catch (e) {}

            const knownWallets = ['nami', 'lace', 'eternl', 'flint', 'typhon', 'yoroi', 'vespr', 'nufi', 'gerowallet', 'begin', 'daedalus'];
            for (const key of knownWallets) {
                try {
                    const wallet = window.cardano[key];
                    if (wallet && typeof wallet.enable === 'function' && !detected.has(key)) {
                        detected.set(key, wallet);
                    }
                } catch (e) {}
            }

            return detected;
        }

        // ============================================================================
        // UI UPDATE
        // ============================================================================
        function updateWalletUI() {
            const btn = document.getElementById('connectBtn');
            const container = document.getElementById('walletListContainer');
            const statusDiv = document.getElementById('walletDetectionStatus');

            const totalWallets = detectedWallets.cardano.size + 
                                (detectedWallets.midnight ? 1 : 0) + 
                                (detectedWallets.ethereum ? 1 : 0);

            if (totalWallets === 0) {
                statusDiv.innerHTML = `<div class="alert alert-warning" style="display: block;"><strong>‚ö†Ô∏è No Wallets</strong><br>Install a wallet and refresh.</div>`;
                btn.textContent = '‚ùå No Wallets';
                btn.disabled = true;
                container.innerHTML = '';
                return;
            }

            statusDiv.innerHTML = `<div class="info-box" style="border-left-color: var(--success);"><h4>‚úÖ ${totalWallets} Wallet${totalWallets > 1 ? 's' : ''} Detected</h4></div>`;

            let html = '';

            if (detectedWallets.cardano.size > 0) {
                html += `<div class="ecosystem-section"><div class="ecosystem-header cardano"><span class="ecosystem-icon">üîµ</span><div class="ecosystem-info"><div class="ecosystem-title">Cardano (CIP-30)</div></div><span class="ecosystem-count">${detectedWallets.cardano.size}</span></div><div class="wallet-grid">`;
                
                for (const [key, wallet] of detectedWallets.cardano) {
                    html += `<div class="wallet-card" data-ecosystem="CARDANO" data-key="${key}" id="wallet-cardano-${key}"><div class="wallet-logo">${getWalletLogo(key)}</div><div class="wallet-name">${wallet.name}</div><div class="wallet-key">${key}</div></div>`;
                }
                
                html += `</div></div>`;
            }

            if (detectedWallets.midnight) {
                html += `<div class="ecosystem-section"><div class="ecosystem-header midnight"><span class="ecosystem-icon">üü£</span><div class="ecosystem-info"><div class="ecosystem-title">Midnight (ZK)</div></div><span class="ecosystem-count">1</span></div><div class="wallet-grid"><div class="wallet-card" data-ecosystem="MIDNIGHT" data-key="midnight" id="wallet-midnight-midnight"><div class="wallet-logo">üåô</div><div class="wallet-name">Midnight Preview</div></div></div></div>`;
            }

            if (detectedWallets.ethereum) {
                html += `<div class="ecosystem-section"><div class="ecosystem-header ethereum"><span class="ecosystem-icon">üü†</span><div class="ecosystem-info"><div class="ecosystem-title">Ethereum (EIP-1193)</div></div><span class="ecosystem-count">1</span></div><div class="wallet-grid"><div class="wallet-card" data-ecosystem="ETHEREUM" data-key="ethereum" id="wallet-ethereum-ethereum"><div class="wallet-logo">ü¶ä</div><div class="wallet-name">${detectedWallets.ethereum.name}</div></div></div></div>`;
            }

            container.innerHTML = html + '<div id="walletDetails"></div>';

            // Attach click listeners to wallet cards
            document.querySelectorAll('.wallet-card').forEach(card => {
                card.addEventListener('click', () => {
                    const ecosystem = card.getAttribute('data-ecosystem');
                    const key = card.getAttribute('data-key');
                    selectWallet(ecosystem, key);
                });
            });

            if (totalWallets === 1) {
                if (detectedWallets.cardano.size === 1) {
                    const [key] = detectedWallets.cardano.keys();
                    selectWallet('CARDANO', key);
                } else if (detectedWallets.midnight) {
                    selectWallet('MIDNIGHT', 'midnight');
                } else if (detectedWallets.ethereum) {
                    selectWallet('ETHEREUM', 'ethereum');
                }
            } else {
                btn.textContent = 'Select a Wallet';
                btn.disabled = true;
            }
        }

        function getWalletLogo(key) {
            const logos = {
                lace: 'üëõ', nami: 'ü¶ä', eternl: '‚ôæÔ∏è', flint: 'üî•',
                typhon: 'üåä', gerowallet: 'üê∫', vespr: '‚ú®',
                yoroi: 'ü¶é', nufi: 'üéØ', begin: 'üå±', daedalus: 'üî∑'
            };
            return logos[key.toLowerCase()] || 'üíº';
        }

        // ============================================================================
        // SELECT WALLET
        // ============================================================================
        function selectWallet(ecosystem, key) {
            document.querySelectorAll('.wallet-card').forEach(card => card.classList.remove('selected'));

            let walletObj;
            if (ecosystem === 'CARDANO') walletObj = detectedWallets.cardano.get(key);
            else if (ecosystem === 'MIDNIGHT') walletObj = detectedWallets.midnight;
            else if (ecosystem === 'ETHEREUM') walletObj = detectedWallets.ethereum;

            if (!walletObj) return;

            selectedWallet = walletObj;
            
            const cardId = `wallet-${ecosystem.toLowerCase()}-${key}`;
            document.getElementById(cardId)?.classList.add('selected');

            const btn = document.getElementById('connectBtn');
            btn.textContent = `Connect ${walletObj.name}`;
            btn.disabled = false;
        }

        // ============================================================================
        // üî• WALLET CONNECTION - WITH CONTRACT INITIALIZATION
        // ============================================================================
        async function connectWallet() {
            if (!selectedWallet) return showAlert('‚ö†Ô∏è Select a wallet', 'warning');

            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Connecting...';

            try {
                connectedEcosystem = selectedWallet.ecosystem;

                if (selectedWallet.ecosystem === 'CARDANO') {
                    wallet = await selectedWallet.api.enable();
                    
                    if (typeof wallet.getNetworkId === 'function') {
                        networkId = await wallet.getNetworkId();
                        networkName = networkId === 1 ? 'üåç Cardano Mainnet' : 'üß™ Cardano Testnet';
                    }

                    let address = null;
                    try {
                        const usedAddresses = await wallet.getUsedAddresses();
                        if (usedAddresses && usedAddresses.length > 0) {
                            address = usedAddresses[0];
                            currentUserAddress = address;
                        }
                    } catch (e) {}

                    walletState = { address: address || '(Pending approval)' };
                    document.getElementById('midnightCapabilityNote').classList.add('hidden');
                }
                else if (selectedWallet.ecosystem === 'MIDNIGHT') {
                    if (typeof selectedWallet.api.enable === 'function') {
                        wallet = await selectedWallet.api.enable();
                    } else {
                        wallet = selectedWallet.api;
                    }
                    
                    if (typeof wallet.state === 'function') {
                        walletState = await wallet.state();
                        currentUserAddress = walletState.address || 'midnight-user';
                        networkName = walletState.address?.includes('_test') ? 'üåô Midnight Testnet' : 'üåô Midnight Mainnet';
                    } else {
                        walletState = { address: 'Connected' };
                        currentUserAddress = 'midnight-user';
                        networkName = 'üåô Midnight Network';
                    }
                    
                    document.getElementById('midnightCapabilityNote').classList.remove('hidden');
                }
                else if (selectedWallet.ecosystem === 'ETHEREUM') {
                    const accounts = await selectedWallet.api.request({ method: 'eth_requestAccounts' });
                    if (!accounts || accounts.length === 0) throw new Error('No accounts');
                    
                    const address = accounts[0];
                    currentUserAddress = address;
                    
                    try {
                        const chainId = await selectedWallet.api.request({ method: 'eth_chainId' });
                        const chainIdDecimal = parseInt(chainId, 16);
                        networkName = { 1: 'üåç Ethereum Mainnet', 11155111: 'üß™ Sepolia' }[chainIdDecimal] || `Chain ${chainIdDecimal}`;
                    } catch (e) {}

                    wallet = selectedWallet.api;
                    walletState = { address };
                    document.getElementById('midnightCapabilityNote').classList.add('hidden');
                }

                // üî• INITIALIZE CONTRACT AND LOAD BALANCE
                ContractIntegration.init();
                balance = ContractIntegration.getBalance(currentUserAddress);
                updateBalance();

                document.getElementById('statusBadge').innerHTML = `<span class="status-dot"></span><span>Connected</span>`;
                document.getElementById('statusBadge').classList.add('connected');
                document.getElementById('walletNameDisplay').textContent = selectedWallet.name;
                document.getElementById('ecosystemDisplay').textContent = selectedWallet.ecosystem;
                document.getElementById('addressDisplay').textContent = walletState.address;
                document.getElementById('networkDisplay').textContent = networkName;

                document.getElementById('connectionSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');

                showAlert(`‚úÖ Connected to ${selectedWallet.name}`, 'success');
                loadState();

            } catch (error) {
                console.error('[Connection] ‚ùå', error);
                showAlert(`‚ùå Failed: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = `Connect ${selectedWallet.name}`;
            }
        }

        // ============================================================================
        // üî• MINT TOKENS - REAL CONTRACT INTEGRATION
        // ============================================================================
        async function mintTokens() {
            if (!wallet) return showAlert('‚ùå Connect wallet first', 'error');

            const amount = parseInt(document.getElementById('mintAmount').value);
            if (!amount || amount <= 0 || amount > 10000) {
                return showAlert('‚ùå Invalid amount (1-10000)', 'error');
            }

            try {
                const btn = document.getElementById('mintBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Minting...';

                console.log(`[Mint] üé® Minting ${amount} tokens...`);
                showAlert('üîê Generating ZK proof...', 'warning');

                // üî• REAL CONTRACT CALL
                const result = await ContractIntegration.mint(amount, currentUserAddress);

                balance = result.newBalance;
                updateBalance();
                addTransaction('MINT', amount, null, result.txHash);
                saveState();

                showAlert(`‚úÖ Minted ${amount} tokens`, 'success');
                btn.disabled = false;
                btn.textContent = '‚ú® Mint Tokens';

            } catch (error) {
                console.error('[Mint] ‚ùå', error);
                showAlert('‚ùå Minting failed: ' + error.message, 'error');
                document.getElementById('mintBtn').disabled = false;
                document.getElementById('mintBtn').textContent = '‚ú® Mint Tokens';
            }
        }

        // ============================================================================
        // üî• TRANSFER TOKENS - REAL CONTRACT INTEGRATION
        // ============================================================================
        async function transferTokens() {
            if (!wallet) return showAlert('‚ùå Connect wallet first', 'error');

            const recipient = document.getElementById('recipientAddress').value.trim();
            const amount = parseInt(document.getElementById('transferAmount').value);

            if (!recipient) return showAlert('‚ùå Enter recipient', 'error');
            if (!amount || amount <= 0) return showAlert('‚ùå Invalid amount', 'error');
            if (amount > balance) return showAlert('‚ùå Insufficient balance', 'error');

            try {
                const btn = document.getElementById('transferBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Sending...';

                console.log(`[Transfer] üì§ Sending ${amount} tokens...`);
                showAlert('üîê Creating transaction...', 'warning');

                // üî• REAL CONTRACT CALL
                const result = await ContractIntegration.transfer(recipient, amount, currentUserAddress);

                balance = result.senderNewBalance;
                updateBalance();
                addTransaction('TRANSFER', amount, recipient, result.txHash);
                saveState();

                showAlert(`‚úÖ Sent ${amount} tokens`, 'success');
                document.getElementById('recipientAddress').value = '';
                document.getElementById('transferAmount').value = '';

                btn.disabled = false;
                btn.textContent = 'üöÄ Send Tokens';

            } catch (error) {
                console.error('[Transfer] ‚ùå', error);
                showAlert('‚ùå Transfer failed: ' + error.message, 'error');
                document.getElementById('transferBtn').disabled = false;
                document.getElementById('transferBtn').textContent = 'üöÄ Send Tokens';
            }
        }

        // ============================================================================
        // UI HELPERS
        // ============================================================================
        function updateBalance() {
            document.getElementById('balanceAmount').textContent = balance;
        }

        function addTransaction(type, amount, recipient = null, txHash = null) {
            transactions.unshift({
                type, amount, recipient, txHash,
                timestamp: new Date().toLocaleString(),
                wallet: selectedWallet.name,
                ecosystem: selectedWallet.ecosystem,
                network: networkName
            });
            if (transactions.length > 20) transactions = transactions.slice(0, 20);
            refreshHistory();
        }

        function refreshHistory() {
            const historyDiv = document.getElementById('txHistory');
            if (transactions.length === 0) {
                historyDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No transactions yet</div>';
                return;
            }

            historyDiv.innerHTML = transactions.map(tx => `
                <div class="tx-item">
                    <div>
                        <div class="tx-type">${tx.type} (${tx.wallet})</div>
                        <div class="tx-time">${tx.timestamp} ‚Ä¢ ${tx.network}</div>
                        ${tx.recipient ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">To: ${tx.recipient.substring(0, 30)}...</div>` : ''}
                        ${tx.txHash ? `<div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 0.25rem;">TX: ${tx.txHash.substring(0, 16)}...</div>` : ''}
                    </div>
                    <div class="tx-amount">${tx.type === 'TRANSFER' ? '-' : '+'}${tx.amount}</div>
                </div>
            `).join('');
        }

        function saveState() {
            localStorage.setItem('midnight_state', JSON.stringify({ balance, transactions }));
        }

        function loadState() {
            const saved = localStorage.getItem('midnight_state');
            if (saved) {
                const state = JSON.parse(saved);
                balance = state.balance || 0;
                transactions = state.transactions || [];
                updateBalance();
                refreshHistory();
            }
        }

        function disconnectWallet() {
            if (confirm('Disconnect wallet?')) {
                wallet = null;
                walletState = null;
                selectedWallet = null;
                currentUserAddress = "default-user";
                
                document.getElementById('statusBadge').innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
                document.getElementById('statusBadge').classList.remove('connected');
                document.getElementById('connectionSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                
                setTimeout(detectWallets, 500);
                showAlert('‚úÖ Disconnected', 'success');
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 5000);
        }

        // ============================================================================
        // üéØ ATTACH EVENT LISTENERS TO BUTTONS
        // ============================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const theme = e.target.getAttribute('data-theme');
                    setTheme(theme);
                });
            });

            // Connect button
            const connectBtn = document.getElementById('connectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', connectWallet);
            }

            // Mint button
            const mintBtn = document.getElementById('mintBtn');
            if (mintBtn) {
                mintBtn.addEventListener('click', mintTokens);
            }

            // Transfer button
            const transferBtn = document.getElementById('transferBtn');
            if (transferBtn) {
                transferBtn.addEventListener('click', transferTokens);
            }

            // Refresh button
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', refreshHistory);
            }

            // Disconnect button
            const disconnectBtn = document.getElementById('disconnectBtn');
            if (disconnectBtn) {
                disconnectBtn.addEventListener('click', disconnectWallet);
            }

            console.log('[UI] ‚úÖ Event listeners attached');
        });

        // Make contract state accessible for debugging
        window.getContractState = () => ContractIntegration.getState();
    </script>
</body>
</html>